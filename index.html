<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• TORRE DE COMANDO - V3.4 (KAMIKAZE)</title>
    <style>
        /* üî• MODO INFERNINHO (CORES V√çVIDAS) üî• */
        :root {
            --bg-dark: #1A1A1D;       /* Quase preto */
            --bg-light: #2C2C34;      /* Cinza escuro */
            --border-color: #4E4E5A;  /* Cinza m√©dio */
            --text-primary: #FFFFFF;  /* Branco */
            --text-secondary: #B0C4DE;/* Azul a√ßo claro */
            --accent-green: #00FF7F;  /* Verde Primavera */
            --accent-red: #FF4500;    /* Laranja-Vermelho */
            --accent-blue: #00BFFF;   /* Azul C√©u Profundo */
            --accent-purple: #9370DB; /* Roxo M√©dio */
            --accent-yellow: #FFD700; /* Ouro */
        }

        body { font-family: monospace; background-color: var(--bg-dark); color: var(--text-primary); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        h1, h2, h3, h4 { border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 10px; color: #fff; }
        #sidebar { width: 30%; min-width: 300px; background-color: var(--bg-light); border-right: 1px solid var(--border-color); height: 100vh; display: flex; flex-direction: column; }
        #sidebar-header { padding: 0 15px; border-bottom: 1px solid var(--border-color); }
        #lead-list-wrapper { overflow-y: auto; flex-grow: 1; }
        #main-panel { width: 70%; display: flex; flex-direction: column; height: 100vh; }
        #chat-window { flex-grow: 1; padding: 20px; overflow-y: auto; }
        #command-center { padding: 15px; background-color: var(--bg-light); border-top: 1px solid var(--border-color); }

        .lead-item { padding: 10px 15px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .lead-item:hover { background-color: #3e3e4a; }
        .lead-item.active { background-color: var(--accent-blue); }
        .lead-item strong { color: var(--text-primary); }
        .lead-item small { color: var(--text-secondary); display: block; }

        .lead-item.status-respondido { background-color: var(--accent-red); animation: pulse-red 1.5s infinite; }
        .lead-item.status-respondido strong,
        .lead-item.status-respondido small { color: #fff !important; font-weight: bold; }
        @keyframes pulse-red { 0% { background-color: var(--accent-red); } 50% { background-color: #B22222; } 100% { background-color: var(--accent-red); } }

        .msg { display: table; margin-bottom: 10px; max-width: 80%; padding: 8px 12px; border-radius: 8px; }
        .msg pre { white-space: pre-wrap; word-wrap: break-word; margin: 0; }
        .msg.inbound { background-color: #3e3e4a; }
        .msg.outbound { background-color: var(--accent-green); color: #000; margin-left: auto; }
        .msg small { color: var(--text-secondary); font-size: 0.75em; display: block; margin-top: 4px; text-align: right; }
        .msg audio, .msg img, .msg video { max-width: 100%; max-height: 300px; margin-top: 5px; border-radius: 5px; }

        input[type="text"], textarea { width: calc(100% - 22px); background-color: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border-color); padding: 10px; margin-bottom: 10px; }
        textarea { height: 60px; resize: none; }
        button { background-color: var(--accent-blue); color: white; border: none; padding: 10px 15px; cursor: pointer; margin: 5px 2px; font-weight: bold; border-radius: 3px; }
        button:hover { opacity: 0.8; }
        button:disabled { background-color: #21262d; color: var(--text-secondary); cursor: not-allowed; }
        button.template { background-color: var(--accent-purple); }
        button.flow { background-color: #444; }
        button.danger { background-color: var(--accent-red); }
        button.pitch { background-color: var(--accent-yellow); color: var(--bg-dark); }
        .comando-grupo { margin-bottom: 15px; }

        #batch-module { padding: 15px; background-color: #010409; border-bottom: 1px solid var(--border-color); }
        #batch-list { height: 100px; width: 100%; box-sizing: border-box; }
        #batch-log { font-size: 0.8em; height: 60px; overflow-y: auto; background-color: var(--bg-dark); border: 1px solid var(--border-color); padding: 5px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div id="sidebar-header">
            <h1>üî• TORRE DE COMANDO</h1>
            <div id="batch-module">
                <h3>‚öîÔ∏è DISPARO EM MASSA (1s) ‚öîÔ∏è</h3>
                <textarea id="batch-list" placeholder="5511999998888&#10;5521999997777&#10;..."></textarea>
                <button id="start-batch-btn" class="danger">INICIAR CA√áADA (1s)</button>
                <div id="batch-log">Log de Disparo: Aguardando ordens...</div>
            </div>
            <h2>Conversas Ativas (Respondidos no Topo)</h2>
            <button onclick="loadLeads()" style="margin-left: 15px;">Atualizar Lista</button>
        </div>
        <div id="lead-list-wrapper">
            <div id="lead-list"></div>
        </div>
    </div>

    <div id="main-panel">
        <div id="chat-window">
            <h2 id="chat-header">Selecione um Alvo</h2>
            <div id="message-list" style="display: flex; flex-direction: column;"></div>
        </div>
        <div id="command-center">
            <h3>CENTRO DE COMANDO: <span id="current-target">N/A</span></h3>

            <div class="comando-grupo">
                <h4>Mensagem Manual (Resposta de Sess√£o)</h4>
                <textarea id="message-input" placeholder="Escreva a resposta..."></textarea>
                <button id="send-text-btn" class="danger">ENVIAR MANUAL</button>

                <button id="send-pitch-btn" class="pitch">ENVIAR PITCH (Fase 1 e 2)</button>
            </div>

            <div class="comando-grupo">
                <h4>Bomba Guiada (Qualifica√ß√£o)</h4>
                <button class="flow" id="send-flow-btn" disabled>Flow Desativado</button>
            </div>
        </div>
    </div>

    <script>
        let currentSelectedPhone = null;
        let isBatchRunning = false;
        // üî• ARSENAL ATUALIZADO (5 TEMPLATES) üî•
        const TEMPLATES_DE_CA√áA = ['primeiro', 'segundo', 'terceiro'];

        // üî• O TEXTO DO SEU PITCH AUTOM√ÅTICO üî•
        const PITCH_TEXT = `O nosso processo √© estruturado em duas fases claras para m√°xima efici√™ncia:
*CONVERSAR COM (19)982642481 este √© um an√∫ncio autom√°tico da APi de envios...*

üéØ Fase 1: Mapeamento e Segmenta√ß√£o de P√∫blico Identificamos seu Perfil de Cliente Ideal (ICP) atrav√©s da an√°lise e cruzamento de fontes de dados p√∫blicas, permitindo segmenta√ß√£o precisa por crit√©rios demogr√°ficos, geogr√°ficos e de renda. O entreg√°vel √© uma lista de contatos qualificados e prontos para a pr√≥xima fase.

ü§ñ Fase 2: Qualifica√ß√£o com Automa√ß√£o IA Um agente de intelig√™ncia artificial √© integrado ao seu canal de WhatsApp. Este agente executa a abordagem inicial, qualifica o n√≠vel de interesse do prospecto e filtra as intera√ß√µes. Sua equipe √© acionada apenas para interagir com leads que j√° demonstraram inten√ß√£o clara.

Pacotes Operacionais:

üì¶ *Pacote Prospec√ß√£o*
5.000 contatos segmentados
Automa√ß√£o de Abordagem (IA)

Valor: R$ (SAIBA MAIS)

üöÄ *Pacote Engajamento Total*
10.000 contatos segmentados
Automa√ß√£o de Abordagem (IA)
Suporte dedicado (30 dias)

Valor: R$ (CONSULTE-NOS)

üîó Amostras de resultados e valida√ß√£o social est√£o dispon√≠veis para an√°lise em: https://renovardominio.com.br

*_Qual pacote de servi√ßo devemos provisionar para ativa√ß√£o imediata?_*

*CONVERSAR COM (19)982642481 este √© um an√∫ncio autom√°tico da APi de envios...*`;


        async function apiFetch(endpoint, method = 'GET', body = null) {
            try {
                const options = { method, headers: { 'Content-Type': 'application/json' } };
                if (body) options.body = JSON.stringify(body);
                const response = await fetch(endpoint, options);

                // üî• CORRE√á√ÉO V3.4: A API de M√≠dia n√£o retorna JSON, ela retorna a M√çDIA
                if (endpoint.startsWith('/api/media/')) {
                    if (!response.ok) throw new Error(`Erro ${response.status} ao buscar m√≠dia`);
                    return await response.blob(); // Retorna o dado bin√°rio
                }

                const responseData = await response.json();
                if (!response.ok) throw new Error(responseData.error || `Erro ${response.status}`);
                return responseData;
            } catch (err) {
                console.error(`Erro na API ${endpoint}:`, err.message);
                logToBatch(`ERRO: ${err.message}`);
                return null;
            }
        }

        async function loadLeads() {
            const data = await apiFetch('/api/leads');
            const list = document.getElementById('lead-list');
            list.innerHTML = '';

            if (data && data.leads && data.leads.length > 0) {
                data.leads.forEach(lead => {
                    const item = document.createElement('div');
                    item.className = 'lead-item';
                    item.id = `lead-${lead.phone}`;
                    if (lead.status === 'respondido') item.classList.add('status-respondido');

                    item.innerHTML = `<strong>${lead.name || 'Desconhecido'} (${lead.phone})</strong>
                                      <small>Status: ${lead.status}</small>
                                      <small>√öltimo Contato: ${new Date(lead.last_message_at).toLocaleString('pt-BR')}</small>`;
                    item.onclick = () => selectLead(lead.phone, lead.name);
                    list.appendChild(item);
                });

                if (currentSelectedPhone) {
                    const activeEl = document.getElementById(`lead-${currentSelectedPhone}`);
                    if (activeEl && !activeEl.classList.contains('status-respondido')) activeEl.classList.add('active');
                }
            } else {
                list.innerHTML = '<p style="padding: 10px;">Nenhum alvo no radar.</p>';
            }
        }

        async function selectLead(phone, name) {
            currentSelectedPhone = phone;
            const leadElement = document.getElementById(`lead-${phone}`);
            if (leadElement.classList.contains('status-respondido')) {
                await apiFetch(`/api/leads/${phone}/mark_read`, 'POST');
                leadElement.classList.remove('status-respondido');
                leadElement.querySelector('small:nth-of-type(1)').innerText = 'Status: lido';
            }

            document.querySelectorAll('.lead-item').forEach(el => el.classList.remove('active'));
            leadElement.classList.add('active');
            document.getElementById('chat-header').innerText = `Hist√≥rico: ${name} (${phone})`;
            document.getElementById('current-target').innerText = phone;
            document.querySelectorAll('#command-center button').forEach(b => b.disabled = (b.id === 'send-flow-btn'));
            await loadMessages(phone);
        }

        // üî• ATUALIZADO V3.4: Renderiza M√≠dia (√Åudio/Imagem/V√≠deo)
        async function loadMessages(phone) {
            const chat = document.getElementById('message-list');
            chat.innerHTML = 'Carregando hist√≥rico...';

            // üî• CORRE√á√ÉO: A API /api/leads/:phone/messages retorna um ARRAY PURO
            const messages = await fetch(`/api/leads/${phone}/messages`).then(res => res.json());
            chat.innerHTML = '';

            if (messages && messages.length > 0) {
                for (const msg of messages) { // Usa 'for...of' para lidar com 'await'
                    const item = document.createElement('div');
                    item.className = `msg ${msg.direction}`;
                    let contentHTML = '';

                    // L√≥gica de renderiza√ß√£o
                    if (['audio', 'image', 'video'].includes(msg.type) && msg.direction === 'inbound') {
                        // Se for m√≠dia recebida, busca ela no bunker
                        try {
                            const mediaBlob = await apiFetch(`/api/media/${msg.content}`);
                            const mediaUrl = URL.createObjectURL(mediaBlob);

                            if (msg.type === 'audio') {
                                contentHTML = `<audio controls src="${mediaUrl}"></audio>`;
                            } else if (msg.type === 'image') {
                                contentHTML = `<img src="${mediaUrl}" alt="M√≠dia recebida">`;
                            } else if (msg.type === 'video') {
                                contentHTML = `<video controls src="${mediaUrl}"></video>`;
                            }
                        } catch (mediaErr) {
                            console.error("Erro ao carregar m√≠dia:", mediaErr);
                            contentHTML = `<pre>(Erro ao carregar m√≠dia ID: ${msg.content})</pre>`;
                        }
                    } else {
                        // Para 'text', 'button_click', 'outbound', etc.
                        contentHTML = `<pre>${msg.content || '(Conte√∫do vazio)'}</pre>`;
                    }

                    item.innerHTML = `${contentHTML}
                                      <small>${new Date(msg.timestamp).toLocaleString('pt-BR')} (tipo: ${msg.type})</small>`;
                    chat.appendChild(item);
                }
            } else {
                chat.innerHTML = '<p>Nenhuma comunica√ß√£o registrada.</p>';
            }
            document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
        }

        // --- L√ìGICA DE CA√áA EM MASSA (O ENXAME) ---
        const batchLog = document.getElementById('batch-log');
        function logToBatch(message) {
            console.log(message);
            batchLog.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}<br>` + batchLog.innerHTML;
        }

        const startBatchBtn = document.getElementById('start-batch-btn');
        startBatchBtn.onclick = async () => {
            if (isBatchRunning) return;
            const rawList = document.getElementById('batch-list').value;
            const phones = rawList.split('\n').map(p => p.trim().replace(/\D/g, '')).filter(p => p.length > 9);
            if (phones.length === 0) return alert('Cole uma lista de n√∫meros v√°lidos.');

            isBatchRunning = true;
            startBatchBtn.disabled = true;
            startBatchBtn.innerText = 'DISPARANDO...';
            logToBatch(`Iniciando ca√ßada... ${phones.length} n√∫meros na lista bruta.`);

            const uniquePhones = [...new Set(phones)];
            logToBatch(`Filtrando ${uniquePhones.length} n√∫meros √∫nicos...`);

            const filterResult = await apiFetch('/api/hunt/batch_filter', 'POST', { phones: uniquePhones });
            if (!filterResult || !filterResult.cleanList) {
                logToBatch("ERRO FATAL: Falha ao filtrar lista no backend.");
                isBatchRunning = false; startBatchBtn.disabled = false; startBatchBtn.innerText = 'INICIAR CA√áADA (1s)'; return;
            }

            const cleanList = filterResult.cleanList;
            logToBatch(`FILTRO: ${cleanList.length} alvos novos. ${filterResult.totalRejeitados} rejeitados (j√° no banco).`);
            if (cleanList.length === 0) {
                logToBatch("Nenhum alvo novo para ca√ßar.");
                isBatchRunning = false; startBatchBtn.disabled = false; startBatchBtn.innerText = 'INICIAR CA√áADA (1s)'; return;
            }

            for (let i = 0; i < cleanList.length; i++) {
                const phone = cleanList[i];
                const templateName = TEMPLATES_DE_CA√áA[Math.floor(Math.random() * TEMPLATES_DE_CA√áA.length)];
                logToBatch(`[${i+1}/${cleanList.length}] Ca√ßando ${phone} com ${templateName}...`);

                const huntResult = await apiFetch('/api/hunt/template', 'POST', {
                    phone: phone, name: `Alvo Frio ${phone.slice(-4)}`, templateName: templateName
                });
                if (huntResult) logToBatch(`-> M√≠ssil enviado para ${phone}.`);
                else logToBatch(`-> FALHA no disparo para ${phone}. (Ver log do bunker)`);

                // üî• CAD√äNCIA SUICIDA (1 SEGUNDO) üî•
                if (i < cleanList.length - 1) {
                    logToBatch(`...Aguardando 1 segundo (CAD√äNCIA SUICIDA)...`);
                    await new Promise(r => setTimeout(r, 1000)); // 1 segundo
                }
            }
            logToBatch("--- CA√áADA EM MASSA CONCLU√çDA ---");
            isBatchRunning = false; startBatchBtn.disabled = false; startBatchBtn.innerText = 'INICIAR CA√áADA (1s)';
            await loadLeads();
        };

        // --- FUN√á√ïES DE RESPOSTA (SESS√ÉO) ---
        document.getElementById('send-text-btn').onclick = async () => {
            if (!currentSelectedPhone) return alert('Selecione um alvo na lista "Conversas Ativas" primeiro!');
            const message = document.getElementById('message-input').value;
            if (!message) return;
            const result = await apiFetch('/api/send/text', 'POST', { phone: currentSelectedPhone, message: message });
            if (result) {
                document.getElementById('message-input').value = '';
                await loadMessages(currentSelectedPhone);
            }
        };

        // üî• BOT√ÉO DE PITCH (V3.4)
        document.getElementById('send-pitch-btn').onclick = async () => {
            if (!currentSelectedPhone) return alert('Selecione um alvo na lista "Conversas Ativas" primeiro!');
            console.log(`Enviando PITCH para ${currentSelectedPhone}...`);
            const result = await apiFetch('/api/send/text', 'POST', {
                phone: currentSelectedPhone,
                message: PITCH_TEXT
            });
            if (result) await loadMessages(currentSelectedPhone);
        };

        document.getElementById('send-flow-btn').onclick = () => {
            alert('Flows desativados. Foco na ca√ßa e no pitch manual.');
        };

        // --- INICIALIZA√á√ÉO ---
        function init() {
            console.log("Torre de Comando V3.4 (Kamikaze) INICIADA.");
            document.querySelectorAll('#command-center button').forEach(b => b.disabled = true);
            loadLeads();
            setInterval(loadLeads, 15000); // Auto-refresh de alvos (15 segundos)
        }
        init();
    </script>
</body>
</html>
